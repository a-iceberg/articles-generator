from __future__ import annotations

import csv
import html
import json
import logging
import os
import re
import textwrap
from datetime import datetime
from pathlib import Path
from typing import List, Tuple, Optional

import tiktoken
from tenacity import retry, stop_after_attempt, wait_exponential_jitter
from openai import OpenAI

from fastapi import FastAPI, HTTPException, UploadFile, File, Form, BackgroundTasks
from pydantic import BaseModel
import uvicorn
from tqdm.auto import tqdm
from fastapi.responses import StreamingResponse, FileResponse
from threading import Thread
from queue import Queue
import uuid
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ù–ê–°–¢–†–û–ô–ö–ò –ü–£–¢–ï–ô ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
# –í–°–ï —Ñ–∞–π–ª—ã —á–∏—Ç–∞–µ–º/–ø–∏—à–µ–º –≤ —Ö–æ—Å—Ç–æ–≤—É—é –ø–∞–ø–∫—É (–º–æ–Ω—Ç–∏—Ä—É–µ–º—É—é –∫–∞–∫ /work).
BASE_DIR = Path(os.getenv("HOST_WORKDIR", "/work"))
BASE_DIR.mkdir(parents=True, exist_ok=True)

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –ü–†–û–ú–ü–¢–´ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
SYSTEM_PROMPT_TZ = (
    "–¢—ã ‚Äî –∞–≤—Ç–æ—Ä —ç–∫—Å–ø–µ—Ä—Ç–Ω–æ–≥–æ –±–ª–æ–≥–∞ –æ —Ä–µ–º–æ–Ω—Ç–µ —Ç–µ—Ö–Ω–∏–∫–∏, —Å–æ–≤–º–µ—â–∞—é—â–∏–π –æ–ø—ã—Ç –º–∞—Å—Ç–µ—Ä–∞ –∏ –∂—É—Ä–Ω–∞–ª–∏—Å—Ç–∞. "
    "–ü–∏—à–µ—à—å –¥–ª—è –º–∞—Å—Ç–µ—Ä–æ–≤ –∏ –æ–±—ã—á–Ω—ã—Ö –ª—é–¥–µ–π, —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω–æ, –ø–æ –¥–µ–ª—É, —Å –æ–ø–æ—Ä–æ–π –Ω–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ. "
    "–¢–æ–Ω –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, –Ω–æ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π, –¥–æ–ø—É—Å–∫–∞–µ—Ç—Å—è –ª—ë–≥–∫–∏–π –∂–∞—Ä–≥–æ–Ω –∏ –±—ã—Ç–æ–≤—ã–µ –ø—Ä–∏–º–µ—Ä—ã. "

    # –ñ—ë—Å—Ç–∫–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
    "–í–ù–ò–ú–ê–ù–ò–ï: –∑–∞–ø—Ä–µ—â–µ–Ω—ã –¥–≤–æ–µ—Ç–æ—á–∏—è, —Ç–∏—Ä–µ, —Å–∫–æ–±–∫–∏, —Å–æ—é–∑—ã ¬´–∏/–∏–ª–∏¬ª –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö –ª—é–±–æ–≥–æ —É—Ä–æ–≤–Ω—è. "
    "–û–¥–∏–Ω –∑–∞–≥–æ–ª–æ–≤–æ–∫ ‚Äî –æ–¥–Ω–∞ –º—ã—Å–ª—å –∏–ª–∏ –æ–¥–∏–Ω –≤–æ–ø—Ä–æ—Å. –ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª–∏–Ω–æ–π 2‚Äì5 —Å–ª–æ–≤, –±–µ–∑ –∫–ª–∏–∫–±–µ–π—Ç–∞. "

    # –ê–Ω—Ç–∏-—É—Å—Ä–µ–¥–Ω–µ–Ω–∏–µ –∏ –∞–Ω—Ç–∏-–ò–ò-—à–∞–±–ª–æ–Ω—ã
    "–ò–∑–±–µ–≥–∞–π –æ–±—Ç–µ–∫–∞–µ–º—ã—Ö —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–æ–∫ (¬´–≤—ã—Å–æ–∫–∞ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å¬ª, ¬´–≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Å–ª—É—á–∞—è—Ö¬ª, ¬´–º–æ–∂–µ—Ç –±—ã—Ç—å¬ª). "
    "–ù–µ –≤—Å—Ç–∞–≤–ª—è–π –ø—É—Å—Ç—ã–µ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ —Ñ—Ä–∞–∑—ã (¬´–≥–ª–∞–≤–Ω—ã–π –ø—Ä–∏–Ω—Ü–∏–ø ‚Äî –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å¬ª) –±–µ–∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –∏ –¥–∞–Ω–Ω—ã—Ö. "
    "–†–∞–∑–¥–µ–ª—ã –Ω–µ –æ–±—è–∑–∞–Ω—ã –±—ã—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º–∏ –ø–æ –æ–±—ä—ë–º—É ‚Äî –≥–ª—É–±–æ–∫–æ —Ä–∞—Å–∫—Ä—ã–≤–∞–π –≤–∞–∂–Ω–æ–µ, –≤—Ç–æ—Ä–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ –æ–ø–∏—Å—ã–≤–∞–π –∫—Ä–∞—Ç–∫–æ. "
    "–°–ø–∏—Å–∫–∏ –¥–µ–ª–∞–π —Ä–∞–∑–Ω–æ–π –¥–ª–∏–Ω—ã –∏ —Ñ–æ—Ä–º—ã, —á–µ—Ä–µ–¥—É–π –∫–æ—Ä–æ—Ç–∫–∏–µ –∏ –¥–ª–∏–Ω–Ω—ã–µ –ø—É–Ω–∫—Ç—ã. "
    "–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –ò–ò-—à–∞–±–ª–æ–Ω—ã –∏ —Å–∏–º–º–µ—Ç—Ä–∏—á–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É, –∏–∑–±–µ–≥–∞–π —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è."
)

TZ_USER_PROMPT_TEMPLATE = textwrap.dedent(
    """
    –ö–û–ù–¢–ï–ö–°–¢
    –°—Ç–∞—Ç—å—è –¥–ª—è –±–ª–æ–≥–∞ –ø—Ä–æ —Ä–µ–º–æ–Ω—Ç —Ç–µ—Ö–Ω–∏–∫–∏. –¢–µ–º–∞ ‚Äî "{main_query}".
    –ê—É–¥–∏—Ç–æ—Ä–∏—è ‚Äî –º–∞—Å—Ç–µ—Ä–∞, –æ–±—ã—á–Ω—ã–µ –ª—é–¥–∏ –ª—é–¥–∏. –¶–µ–ª—å ‚Äî —Å—Ç–∞—Ç—å –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–º –±–ª–æ–≥–æ–º –¥–ª—è –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª–æ–≤, —Ä–µ–∞–ª—å–Ω–∞—è —ç–∫—Å–ø–µ—Ä—Ç–∏–∑–∞, –ø–æ–ª—å–∑–∞ –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ª—é–¥–µ–π.

    –†–û–õ–¨
    –¢—ã ‚Äî –±–ª–æ–≥–µ—Ä, –ø–∏—à–µ—à—å –Ω–∞ —Ç–µ–º—É —Ä–µ–º–æ–Ω—Ç–∞ —Ç–µ—Ö–Ω–∏–∫–∏. –ü–∏—à–µ—à—å –∫–æ—Ä–æ—Ç–∫–æ, –ø–æ –¥–µ–ª—É, —É–≤–∞–∂–∏—Ç–µ–ª—å–Ω–æ. –û–ø–∏—Ä–∞–µ—à—å—Å—è –Ω–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.

    –ò–ù–°–¢–†–£–ö–¶–ò–Ø
    –†–∞–∑—Ä–∞–±–æ—Ç–∞–π –ø–æ–¥—Ä–æ–±–Ω—É—é SEO‚Äë—Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å—Ç–∞—Ç—å–∏ (–ø–ª–∞–Ω) —Å —á—ë—Ç–∫–æ–π –∏–µ—Ä–∞—Ä—Ö–∏–µ–π H1‚ÄìH3. –†–∞—Å–ø—Ä–µ–¥–µ–ª–∏ –∫–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–º –±–ª–æ–∫–∞–º. –°–¥–µ–ª–∞–π –∑–∞–º–µ—Ç–∫–∏, –≥–¥–µ –±—É–¥—É—Ç —Å–ø–∏—Å–∫–∏, —Ç–∞–±–ª–∏—Ü—ã, —á–µ–∫-–ª–∏—Å—Ç—ã.

    –°–¢–ò–õ–¨
    –Ø–∑—ã–∫ ‚Äî –ø—Ä–æ—Å—Ç–æ–π –∏ –ø—Ä—è–º–æ–π; –∫–æ—Ä–æ—Ç–∫–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è; –¥—Ä—É–∂–µ–ª—é–±–Ω–æ –∏ —Å —É–≤–∞–∂–µ–Ω–∏–µ–º; –±–µ–∑ —à—Ç–∞–º–ø–æ–≤ –∏ –∫–∞–Ω—Ü–µ–ª—è—Ä–∏—Ç–∞; –Ω–µ–º–Ω–æ–≥–æ –∂–∞—Ä–≥–æ–Ω–∞; –±—ã—Ç–æ–≤—ã–µ –ø—Ä–∏–º–µ—Ä—ã —É–º–µ—Å—Ç–Ω—ã.

    TONE OF VOICE
    –ü–µ—Ä–µ–¥ –Ω–∞–ø–∏—Å–∞–Ω–∏–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä—É–π –¥–ª—è "–∞–≤—Ç–æ—Ä–∞" —Å–ª—É—á–∞–π–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ –ë–æ–ª—å—à–æ–π –ü—è—Ç—ë—Ä–∫–µ (—ç–∫—Å—Ç—Ä–∞–≤–µ—Ä—Å–∏—è, –¥–æ–±—Ä–æ–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å, —Å–æ–∑–Ω–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å, –Ω–µ–π—Ä–æ—Ç–∏–∑–º, –æ—Ç–∫—Ä—ã—Ç–æ—Å—Ç—å –æ–ø—ã—Ç—É) –ø–∏—à–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å—Ç–∞—Ç—å–∏ —Å —É—á–µ—Ç–æ–º –∑–Ω–∞—á–µ–Ω–∏–π —ç—Ç–∏—Ö —á–µ—Ä—Ç.

    –ñ–Å–°–¢–ö–ò–ï –ê–ù–¢–ò-–ü–ê–¢–¢–ï–†–ù–´
    ‚Ä¢ –ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å ¬´–≤—ã—Å–æ–∫–∞ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å¬ª, ¬´–≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Å–ª—É—á–∞—è—Ö¬ª, ¬´–º–æ–∂–µ—Ç –±—ã—Ç—å¬ª –∏ –¥—Ä—É–≥–∏–µ —Ä–∞–∑–º—ã—Ç—ã–µ –≤—ã—Ä–∞–∂–µ–Ω–∏—è.
    ‚Ä¢ –ù–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—É—Å—Ç—ã–µ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ —Ñ—Ä–∞–∑—ã (¬´–≥–ª–∞–≤–Ω—ã–π –ø—Ä–∏–Ω—Ü–∏–ø ‚Äî –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å¬ª, ¬´—Å–ª–µ–¥—É–µ—Ç –ø–æ–º–Ω–∏—Ç—å¬ª) –±–µ–∑ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π, –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏–ª–∏ —Ü–∏—Ñ—Ä.
    ‚Ä¢ –†–∞–∑–¥–µ–ª—ã –∏ –ø—É–Ω–∫—Ç—ã —Å–ø–∏—Å–∫–∞ –Ω–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –æ–¥–∏–Ω–∞–∫–æ–≤–æ–π –¥–ª–∏–Ω—ã –∏–ª–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã.
    ‚Ä¢ –ß–µ—Ä–µ–¥—É–π –∫–æ—Ä–æ—Ç–∫–∏–µ –∏ –¥–ª–∏–Ω–Ω—ã–µ –ø—É–Ω–∫—Ç—ã, –≥–¥–µ-—Ç–æ –æ–¥–Ω–æ —Å–ª–æ–≤–æ, –≥–¥–µ-—Ç–æ –∞–±–∑–∞—Ü.
    ‚Ä¢ –†–∞–∑–Ω–∞—è –≥–ª—É–±–∏–Ω–∞ –ø—Ä–æ—Ä–∞–±–æ—Ç–∫–∏ —Ä–∞–∑–¥–µ–ª–æ–≤: –≤–∞–∂–Ω–æ–µ —Ä–∞—Å–∫—Ä—ã–≤–∞—Ç—å –≥–ª—É–±–æ–∫–æ, –≤—Ç–æ—Ä–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ ‚Äî –∫—Ä–∞—Ç–∫–æ.
    ‚Ä¢ –ò–∑–±–µ–≥–∞—Ç—å —Å–∏–º–º–µ—Ç—Ä–∏—á–Ω—ã—Ö —Å–ø–∏—Å–∫–æ–≤, –ò–ò-—à–∞–±–ª–æ–Ω–æ–≤ –∏ —É—Å—Ä–µ–¥–Ω—ë–Ω–Ω–æ—Å—Ç–∏.

    –ó–ê–ì–û–õ–û–í–ö–ò H1-H6
    2-5 —Å–ª–æ–≤, –æ–¥–Ω–∞ —Ñ—Ä–∞–∑–∞, –±–µ–∑ –¥–≤–æ–µ—Ç–æ—á–∏–π, —Ç–∏—Ä–µ, —Å–∫–æ–±–æ–∫ –∏ –≤–æ–ø—Ä–æ—Å–æ–≤. –ù–∏–∫–∞–∫–∏—Ö —É—Ç–æ—á–Ω–µ–Ω–∏–π –ø–æ—Å–ª–µ –∑–Ω–∞–∫–æ–≤.
    –ó–∞–ø—Ä–µ—â–µ–Ω–æ –¥–≤–æ–µ—Ç–æ—á–∏–µ (:), —Ç–∏—Ä–µ (‚Äî/‚Äì), —Å–∫–æ–±–∫–∏, —Å–æ—é–∑—ã ¬´–∏/–∏–ª–∏¬ª.

    –°–¢–†–£–ö–¢–£–†–ê (—Ä–∞–∑—Ä–∞–±–æ—Ç–∞–π –∏–∑ –ø–æ–¥—Ö–æ–¥—è—â–∏—Ö –¥–ª—è —Ç–µ–º—ã –±–ª–æ–∫–æ–≤):

    –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ:
    ‚Äî H1: —Ç–æ—á–Ω—ã–π, –ø–æ–Ω—è—Ç–Ω—ã–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –±–µ–∑ –∫–ª–∏–∫–±–µ–π—Ç–∞.
    ‚Äî –ü–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∏ H2/H3/H4: –ª–æ–≥–∏—á–Ω–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ –¥–ª–∏–Ω–Ω—ã—Ö —Å–µ–∫—Ü–∏–π –≤–Ω—É—Ç—Ä–∏ —Å—Ç–∞—Ç—å–∏.


    –ù–∞ –≤—ã–±–æ—Ä:
    ‚Äî –ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ/–ª–∏–¥-–∞–±–∑–∞—Ü: 1‚Äì2 –µ–º–∫–∏—Ö –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, —Ä–∞—Å–∫—Ä—ã–≤–∞—é—â–∏—Ö —Å—É—Ç—å.
    ‚Äî –ê–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç—å: ‚Äú–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∞–∫—Ç—É–∞–ª—å–Ω–∞ –Ω–∞ [–º–µ—Å—è—Ü, –≥–æ–¥]‚Äù, –≤–∞–∂–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è, –Ω–æ–≤–æ–≤–≤–µ–¥–µ–Ω–∏—è.
    ‚Äî –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ/—Å–æ–¥–µ—Ä–∂–∞–Ω–∏–µ: –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –∏–ª–∏ —Å–ª–æ–∂–Ω—ã—Ö —Å—Ç–∞—Ç–µ–π ‚Äî —è–∫–æ—Ä—è.
    ‚Äî –í–≤–µ–¥–µ–Ω–∏–µ / –ö–æ–Ω—Ç–µ–∫—Å—Ç / –ü—Ä–µ–¥—ã—Å—Ç–æ—Ä–∏—è: –∑–∞—á–µ–º –∏ –∫–æ–º—É –±—É–¥–µ—Ç –ø–æ–ª–µ–∑–Ω–∞ —Å—Ç–∞—Ç—å—è, –ø–æ—á–µ–º—É —Ç–µ–º–∞ –≤–∞–∂–Ω–∞ —Å–µ–π—á–∞—Å.
    ‚Äî –§–∞–∫—Ç—ã –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: —Ü–∏—Ñ—Ä—ã, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞, —Ç–µ–Ω–¥–µ–Ω—Ü–∏–∏, –µ—Å–ª–∏ —É–º–µ—Å—Ç–Ω–æ.
    ‚Äî –ì–ª–æ—Å—Å–∞—Ä–∏–π / –ø–æ—è—Å–Ω–µ–Ω–∏–µ —Ç–µ—Ä–º–∏–Ω–æ–≤: –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö/—Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–µ–º.
    ‚Äî –ü–æ—à–∞–≥–æ–≤–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è: –ø–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ + –Ω—É–º–µ—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –¥–µ–π—Å—Ç–≤–∏–π.
    ‚Äî –ß–µ–∫-–ª–∏—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤/—Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π: —Å–ø–∏—Å–æ–∫ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –±—É–º–∞–≥ –∏ —Å–≤–µ–¥–µ–Ω–∏–π.
    ‚Äî –¢–∞–±–ª–∏—Ü—ã, —Å—Ä–∞–≤–Ω–µ–Ω–∏—è –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤, –∏–Ω—ã–µ –≤–∞–∂–Ω—ã–µ —Ç–∞–±–ª–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.
    ‚Äî –ö—É–¥–∞ –æ–±—Ä–∞—â–∞—Ç—å—Å—è: –∫–æ–Ω—Ç–∞–∫—Ç—ã, –ø–æ–¥—Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è, –ø–æ—Ä—Ç–∞–ª—ã, –≥–æ—Ä—è—á–∏–µ –ª–∏–Ω–∏–∏ (–±–µ–∑ –∑–∞–∫—Ä—ã—Ç—ã—Ö —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤).
    ‚Äî –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä, —Ñ–æ—Ä–º—É–ª—ã –∏–ª–∏ —Å—Ö–µ–º–∞ —Ä–∞—Å—á—ë—Ç–∞: –µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è —Ä–∞—Å—á–µ—Ç –≤—ã–ø–ª–∞—Ç, —Å—Ä–æ–∫–æ–≤ –∏ –ø—Ä.
    ‚Äî –ß–∞—Å—Ç—ã–µ –æ—à–∏–±–∫–∏ –∏ –∫–∞–∫ –∏–∑–±–µ–∂–∞—Ç—å: —Ä–∞—Å–ø—Ä–æ—Å—Ç—Ä–∞–Ω—ë–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏, –ª–∞–π—Ñ—Ö–∞–∫–∏ –ø–æ –∏—Ö –∏—Å–∫–ª—é—á–µ–Ω–∏—é.
    ‚Äî –ü—Ä–∏–º–µ—Ä—ã / –∫–µ–π—Å—ã / —Ä–µ–∞–ª—å–Ω—ã–µ –∏—Å—Ç–æ—Ä–∏–∏: –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∏–ª–ª—é—Å—Ç—Ä–∞—Ü–∏–∏, —Ç–∏–ø–æ–≤—ã–µ —Å–∏—Ç—É–∞—Ü–∏–∏.
    ‚Äî –ú–Ω–µ–Ω–∏–µ / —Ü–∏—Ç–∞—Ç–∞ —ç–∫—Å–ø–µ—Ä—Ç–∞ / –∏–Ω—Ç–µ—Ä–≤—å—é: –ø—Ä—è–º—ã–µ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤, –∞–≤—Ç–æ—Ä—Å–∫–∞—è –ø–æ–∑–∏—Ü–∏—è.
    ‚Äî –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∏ –Ω–µ–¥–æ—Å—Ç–∞—Ç–∫–∏: —Å—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑, –ø–ª—é—Å—ã-–º–∏–Ω—É—Å—ã –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ (–µ—Å–ª–∏ –ø—Ä–∏–º–µ–Ω–∏–º–æ).
    ‚Äî –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã —Ä–µ—à–µ–Ω–∏—è: –µ—Å–ª–∏ –µ—Å—Ç—å —Ä–∞–∑–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã/–ø—É—Ç–∏.
    ‚Äî FAQ: –º–∏–Ω–∏–º—É–º 5 –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤.
    ‚Äî –û–±—Ä–∞–∑—Ü—ã, —à–∞–±–ª–æ–Ω—ã: –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤, –∑–∞—è–≤–ª–µ–Ω–∏–π, –¥–æ–≥–æ–≤–æ—Ä–æ–≤ (–µ—Å–ª–∏ –Ω—É–∂–Ω—ã).
    ‚Äî –í–∏–¥–µ–æ-/–∞—É–¥–∏–æ–º–∞—Ç–µ—Ä–∏–∞–ª—ã, –∏–Ω—Ñ–æ–≥—Ä–∞—Ñ–∏–∫–∞, —Å–∫—Ä–∏–Ω—à–æ—Ç—ã: –µ—Å–ª–∏ –æ–±—ä—è—Å–Ω–∏—Ç—å —Å–ª–æ–≤–∞–º–∏ —Å–ª–æ–∂–Ω–æ.
    ‚Äî –ü–æ–¥–≤–æ–¥–Ω—ã–µ –∫–∞–º–Ω–∏ / –≤–∞–∂–Ω—ã–µ –Ω—é–∞–Ω—Å—ã / –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏: —Ç–æ–Ω–∫–æ—Å—Ç–∏, –∏—Å–∫–ª—é—á–µ–Ω–∏—è, —á–∞—Å—Ç–Ω—ã–µ —Å–ª—É—á–∞–∏.
    ‚Äî –î–∏—Å–∫–ª–µ–π–º–µ—Ä ("–í–∞–∂–Ω–æ"): –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞–∫—Ç—É–∞–ª—å–Ω–æ—Å—Ç–∏, –≤–∑–≥–ª—è–¥ –Ω–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏, –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ª–∏—á–Ω–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏.
    ‚Äî Call to action: —Å–æ–≤–µ—Ç —á—Ç–æ –¥–µ–ª–∞—Ç—å –¥–∞–ª—å—à–µ, –∫—É–¥–∞ –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è, —á–µ–º –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ –∑–∞–¥–∞—á–µ).
    –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ —Ç–µ –±–ª–æ–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–¥—Ö–æ–¥—è—Ç –¥–ª—è —Ç–µ–º—ã –∏ —Ñ–æ—Ä–º–∞—Ç–∞ —Å—Ç–∞—Ç—å–∏. –û—Å—Ç–∞–ª—å–Ω—ã–µ –ø—Ä–æ–ø—É—Å–∫–∞–π.
    –î–ª—è –∫–∞–∂–¥–æ–≥–æ –±–ª–æ–∫–∞ –¥–∞–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ø–æ –Ω–∞–ø–∏—Å–∞–Ω–∏—é –∏—Å—Ö–æ–¥—è –∏–∑ –ª–∏—á–Ω–æ—Å—Ç–∏ –∞–≤—Ç–æ—Ä–∞

    –û–ë–™–ï–ú
    –í—ã–±–µ—Ä–∏ –æ–±—ä–µ–º –ø–æ–¥—Ö–æ–¥—è—â–∏–π –ø–æ–¥ —Ç–µ–º—É: –æ—Ç 3000 –¥–æ 20000 –∑–Ω–∞–∫–æ–≤.
    –î–ª—è –∫–∞–∂–¥–æ–≥–æ –±–ª–æ–∫–∞ —É–∫–∞–∂–∏ –ø—Ä–∏–º–µ—Ä–Ω—ã–π –æ–±—ä—ë–º (–≤ –∑–Ω–∞–∫–∞—Ö).

    –ö–õ–Æ–ß–ï–í–´–ï –§–†–ê–ó–´
    –ò—Å–ø–æ–ª—å–∑—É–π –≤ –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö, –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö –∏ –ø–µ—Ä–≤—ã—Ö –∞–±–∑–∞—Ü–∞—Ö:
    {phrases_block}

    –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
    –ü—Ä–µ–¥—Å—Ç–∞–≤—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å—Ç–∞—Ç—å–∏ –≤ –≤–∏–¥–µ –ø–æ–¥—Ä–æ–±–Ω–æ–≥–æ –ø–ª–∞–Ω–∞:
    –Ø–í–ù–û –ü–†–û–ü–ò–®–ò –ó–ê–ì–û–õ–û–í–û–ö H1
    –û—Ç–º–µ—á–∞–π –æ—Å—Ç–∞–ª—å–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏! (H2‚ÄìH6)
    –î–ª—è –∫–∞–∂–¥–æ–≥–æ –±–ª–æ–∫–∞ ‚Äî –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—è (–ø—Ä–æ —á—Ç–æ —ç—Ç–æ—Ç —Ä–∞–∑–¥–µ–ª)
    –î–ª—è –∫–∞–∂–¥–æ–π —Ç–µ–º—ã, –∏–¥–µ–∏ –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–∞ ‚Äî —É–∫–∞–∂–∏ –ø—Ä–∏–º–µ—Ä–Ω—ã–π –æ–±—ä—ë–º –≤ –∑–Ω–∞–∫–∞—Ö
    –î–µ–ª–∞–π –ø–æ–º–µ—Ç–∫–∏, –≥–¥–µ –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å–ø–∏—Å–∫–∏, —Ç–∞–±–ª–∏—Ü—ã, —Ü–∏—Ç–∞—Ç—ã, –≤–∏–∑—É–∞–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã, FAQ –∏ –¥—Ä.

    –ß–ï–ö–õ–ò–°–¢ –ü—Ä–æ–≤–µ—Ä—å –∫–æ–≥–¥–∞ –∑–∞–∫–æ–Ω—á–∏—à—å!
    –ü—Ä–æ–≤–µ—Ä—å —É–∫–∞–∑–∞–ª –ª–∏ —è–≤–Ω–æ –∑–∞–≥–æ–ª–æ–≤–æ–∫ H1 (–Ω—É–∂–Ω–∞ –ø–æ–º–µ—Ç–∫–∞ H1)
    –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–ª–æ–∫–æ–≤ –≤ —á—ë—Ç–∫–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –≤–∏–¥–µ, —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º, –º–µ—Ç–∫–∞–º–∏, –æ–±—ä—ë–º–∞–º–∏.
    """
).strip()

ARTICLE_USER_PROMPT_TEMPLATE = textwrap.dedent(
    """
    <articleId>{article_id}</articleId>

    –ù–∞–ø–∏—à–∏ –ü–û–õ–ù–£–Æ —Å—Ç–∞—Ç—å—é (‚âà15‚ÄØ000 –∑–Ω.) –ø–æ —ç—Ç–æ–º—É —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–º—É –∑–∞–¥–∞–Ω–∏—é:
    ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    {tz_text}
    ‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî‚Äî
    """
).strip()

INSTRUCTIONS_ARTICLE = textwrap.dedent("""
    "–¢—ã ‚Äî —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∫–æ–ø–∏—Ä–∞–π—Ç–µ—Ä. –ü–∏—à–∏ —Å—Ç–∞—Ç—å—é —Å—Ç—Ä–æ–≥–æ –ø–æ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–º—É –∑–∞–¥–∞–Ω–∏—é, —Ç–æ–ª—å–∫–æ –≥–æ—Ç–æ–≤—ã–π HTML-—Ç–µ–∫—Å—Ç. "
    "‚ùó –ù–ï –æ—Ñ–æ—Ä–º–ª—è–π –æ—Ç–≤–µ—Ç –≤ –≤–∏–¥–µ markdown-–±–ª–æ–∫–∞ ```html```. "
    "–ë–µ–∑ –∫–∞—Ä—Ç–∏–Ω–æ–∫ –∏ –≤–Ω–µ—à–Ω–∏—Ö —Å—Å—ã–ª–æ–∫. –ò—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ —Ç–µ–≥–∏ <h1>‚Äì<h6>, <p>, <ul>/<ol>, <table>. "
    "–°—Ç–∏–ª—å, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞, –ª–µ–∫—Å–∏–∫–∞ ‚Äî –∫–∞–∫ –≤ –ø—Ä–∏–º–µ—Ä–∞—Ö –∏–∑ vector store. "
    "–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π –¥–≤–æ–µ—Ç–æ—á–∏—è –∏ —Å–æ—Å—Ç–∞–≤–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ (—Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ –º—ã—Å–ª—å –Ω–∞ –∑–∞–≥–æ–ª–æ–≤–æ–∫). "
    "–ù–µ –∏—Å–ø–æ–ª—å–∑—É–π —Ñ–æ—Ä–º—É–ª—ã –≤—Ä–æ–¥–µ ¬´–ø—Ä–∏—á–∏–Ω—ã –∏ —á—Ç–æ –¥–µ–ª–∞—Ç—å¬ª, ¬´–ø–æ—á–µ–º—É –∏ –∫–∞–∫ —Ä–µ—à–∏—Ç—å¬ª, ¬´FAQ –ø–æ —Ç–µ–º–µ¬ª –∏ —Ç.–ø. "
    "–í –∫–∞–∂–¥–æ–º –∑–∞–≥–æ–ª–æ–≤–∫–µ ‚Äî —Ç–æ–ª—å–∫–æ –æ—Ç–¥–µ–ª—å–Ω—ã–π —Å–º—ã—Å–ª, –≤–æ–ø—Ä–æ—Å –∏–ª–∏ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ. "
    "–°–ø–∏—Å–∫–∏ –¥–µ–ª–∞–π —Ä–∞–∑–Ω–æ–æ–±—Ä–∞–∑–Ω—ã–º–∏: –æ–¥–Ω–∏ –ø—É–Ω–∫—Ç—ã –º–æ–≥—É—Ç –±—ã—Ç—å –¥–ª–∏–Ω–Ω—ã–º–∏, –¥—Ä—É–≥–∏–µ ‚Äî –æ—á–µ–Ω—å –∫–æ—Ä–æ—Ç–∫–∏–º–∏, –≥–¥–µ-—Ç–æ —Ç–æ–ª—å–∫–æ —Å–ª–æ–≤–æ –∏–ª–∏ –ø–∞—Ä–∞ —Å–ª–æ–≤, –≥–¥–µ-—Ç–æ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ. "
    "–ù–µ –¥–µ–ª–∞–π –ø—É–Ω–∫—Ç—ã –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º–∏ –ø–æ —Ä–∞–∑–º–µ—Ä—É –∏–ª–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ. "
    "FAQ, —Ç–∞–±–ª–∏—Ü—ã –∏ –±–ª–æ–∫–∏ –≤–æ–ø—Ä–æ—Å–æ–≤ ‚Äî —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ —Ä–µ–∞–ª—å–Ω–æ —É–º–µ—Å—Ç–Ω–æ –ø–æ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—é, –Ω–µ –¥–æ–±–∞–≤–ª—è–π —à–∞–±–ª–æ–Ω–Ω—ã—Ö –±–ª–æ–∫–æ–≤ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. "
    "–°—Ç–∞—Ä–∞–π—Å—è –ø–∏—Å–∞—Ç—å –∫–∞–∫ —Ä–µ–∞–ª—å–Ω—ã–π –∞–≤—Ç–æ—Ä –±–ª–æ–≥–∞ ‚Äî —Å –ª—ë–≥–∫–∏–º–∏ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è–º–∏ –æ—Ç —à–∞–±–ª–æ–Ω–∞, –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–º —è–∑—ã–∫–æ–º, –∏–Ω–æ–≥–¥–∞ —Ä–∞–∑–≥–æ–≤–æ—Ä–Ω–æ, –±–µ–∑ –∏–∑–ª–∏—à–Ω–µ–π –≤—ã–ª–∏–∑–∞–Ω–Ω–æ—Å—Ç–∏. "
    "–ó–∞–ø—Ä–µ—â–µ–Ω—ã –æ–±—Ç–µ–∫–∞–µ–º—ã–µ —Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∫–∏ (¬´–≤—ã—Å–æ–∫–∞ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å¬ª, ¬´–≤ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö —Å–ª—É—á–∞—è—Ö¬ª, ¬´–º–æ–∂–µ—Ç –±—ã—Ç—å¬ª). "
    "–ù–µ –≤—Å—Ç–∞–≤–ª—è–π —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ –ø—É—Å—Ç—ã–µ —Ñ—Ä–∞–∑—ã (¬´–≥–ª–∞–≤–Ω—ã–π –ø—Ä–∏–Ω—Ü–∏–ø ‚Äî –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å¬ª) –±–µ–∑ –∫–æ–Ω–∫—Ä–µ—Ç–∏–∫–∏ –∏ –¥–µ–π—Å—Ç–≤–∏–π. "
    "–ò–∑–±–µ–≥–∞–π —É—Å—Ä–µ–¥–Ω–µ–Ω–∏—è ‚Äî –≥–ª—É–±–∏–Ω–∞ –∏ –æ–±—ä—ë–º —Ä–∞–∑–¥–µ–ª–æ–≤ –º–æ–≥—É—Ç —Å–∏–ª—å–Ω–æ —Ä–∞–∑–ª–∏—á–∞—Ç—å—Å—è, –Ω–µ –¥–µ–ª–∞–π —Å–∏–º–º–µ—Ç—Ä–∏—á–Ω—ã—Ö —Å–ø–∏—Å–∫–æ–≤ –∏ –±–ª–æ–∫–æ–≤. "
    "–ù–µ –≤—Å—Ç–∞–≤–ª—è–π —Ç–µ–∫—Å—Ç –¢–ó, –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π markdown, –Ω–∏–∫–∞–∫–∏—Ö —Å–ª—É–∂–µ–±–Ω—ã—Ö –ø–æ–º–µ—Ç–æ–∫ ‚Äî —Ç–æ–ª—å–∫–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å—Ç–∞—Ç—å–∏."
""").strip()

# –°—Ç–æ–∏–º–æ—Å—Ç—å 
INPUT_COST_PER_M = 2.00
OUTPUT_COST_PER_M = 8.00

# –ú–æ–¥–µ–ª—å, –ª–∏–º–∏—Ç—ã, —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞
MODEL_NAME = "gpt-4.1"
MAX_TOKENS_TZ = 3500
MAX_TOKENS_ARTICLE = 6000
TEMPERATURE = 1

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –£–¢–ò–õ–ò–¢–´ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
def count_tokens(text: str, model=MODEL_NAME):
    try:
        encoder = tiktoken.encoding_for_model(model)
    except KeyError:
        encoder = tiktoken.get_encoding("cl100k_base")
    return len(encoder.encode(text))

def calculate_cost(tokens, input=True):
    tokens_in_millions = tokens / 1_000_000
    return tokens_in_millions * (INPUT_COST_PER_M if input else OUTPUT_COST_PER_M)

def load_openai_key() -> str:
    if (key := os.environ.get("OPENAI_API_KEY")):
        return key
    auth_file = BASE_DIR / "auth.json"
    if auth_file.exists():
        with auth_file.open(encoding="utf-8") as f:
            return json.load(f)["OPENAI_API_KEY"]
    raise RuntimeError("OpenAI key not found in env or auth.json")

def load_vector_store_id() -> str:
    state_file = BASE_DIR / "state.json"
    if not state_file.exists():
        raise RuntimeError("–§–∞–π–ª state.json –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ä–∞–±–æ—á–µ–π –ø–∞–ø–∫–µ. –í –Ω—ë–º –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å vector_store_id.")
    with state_file.open(encoding="utf-8") as f:
        state = json.load(f)
    if "vector_store_id" not in state:
        raise RuntimeError("–í state.json –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∫–ª—é—á vector_store_id.")
    return state["vector_store_id"]

def slugify(text_: str) -> str:
    text_ = re.sub(r"<[^>]+>", "", text_)
    text_ = re.sub(r"[^\w\s-]", "", text_, flags=re.U).strip().lower()
    return re.sub(r"[\s_-]+", "-", text_)

def parse_groups(csv_path: Path) -> list[str]:
    with csv_path.open(encoding="utf-8", errors="ignore") as f:
        lines = [line.strip() for line in f if line.strip()]
    return lines[1:] 

def extract_keywords(block: str) -> List[Tuple[str, int]]:
    pairs: List[Tuple[str, int]] = []
    for part in re.split(r"[;\n]", block):
        if ":" not in part:
            continue
        key, freq = map(str.strip, part.split(":", 1))
        if freq.isdigit():
            pairs.append((key, int(freq)))
    return pairs

@retry(wait=wait_exponential_jitter(initial=1, max=20), stop=stop_after_attempt(3))
def chat_complete(client: OpenAI, messages: list[dict], max_tokens: int) -> tuple[str, int, int]:
    response = client.chat.completions.create(
        model=MODEL_NAME,
        messages=messages,
        max_tokens=max_tokens,
        temperature=TEMPERATURE,
    )
    content = response.choices[0].message.content.strip()
    usage = response.usage
    prompt_tokens = usage.prompt_tokens if usage else count_tokens(str(messages))
    completion_tokens = usage.completion_tokens if usage else count_tokens(content)
    return content, prompt_tokens, completion_tokens

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ –û–°–ù–û–í–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
def generate_articles(input_csv: Path, groups_start: int, groups_end: Optional[int], save_html: bool = False):
    # –õ–æ–≥–∏
    logging.getLogger("httpx").setLevel(logging.WARNING)
    logging.getLogger("openai").setLevel(logging.WARNING)
    logging.basicConfig(format="%(levelname)s: %(message)s", level=logging.INFO)

    # –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–∞ –∏ –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞
    client = OpenAI(api_key=load_openai_key())
    vector_store_id = load_vector_store_id()

    # –ü—É—Ç–∏ –Ω–∞ —Ö–æ—Å—Ç–µ
    input_csv = input_csv if input_csv.is_absolute() else (BASE_DIR / input_csv)
    if not input_csv.exists():
        raise FileNotFoundError(f"–í—Ö–æ–¥–Ω–æ–π CSV –Ω–µ –Ω–∞–π–¥–µ–Ω: {input_csv}")

    out_csv = BASE_DIR / "articles.csv"

    groups = parse_groups(input_csv)
    if groups_end is None:
        groups_slice = groups[groups_start:]
    else:
        groups_slice = groups[groups_start:groups_end]

    # CSV
    with out_csv.open("w", newline="", encoding="utf-8") as csvfile:
        writer = csv.DictWriter(csvfile, fieldnames=["title", "slug", "tz", "html"])
        writer.writeheader()

        total_cost = 0.0
        saved_html_files = []

        pbar = tqdm(groups_slice, desc="–û–±—Ä–∞–±–æ—Ç–∫–∞ –≥—Ä—É–ø–ø", unit="grp", dynamic_ncols=True, disable=True)
        pbar.set_postfix_str(f"—Å—É–º–º–∞ ${total_cost:.4f}")

        for i, block in enumerate(pbar, 1):
            tqdm.write(f"–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –≥—Ä—É–ø–ø–∞ {i} –∏–∑ {len(groups_slice)}")

            keywords = extract_keywords(block)
            if not keywords:
                tqdm.write(f"‚ö†Ô∏è –ì—Ä—É–ø–ø–∞ {i} –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–ª—é—á–µ–π ‚Äî –ø—Ä–æ–ø—É—â–µ–Ω–∞")
                pbar.update(0)
                continue

            main_query = keywords[0][0]
            phrases_block = "\n".join(f"{k} —á–∞—Å—Ç–æ—Ç–Ω–æ—Å—Ç—å {f}" for k, f in keywords)

            # –¢–ó
            tz_prompt = TZ_USER_PROMPT_TEMPLATE.format(
                main_query=main_query, phrases_block=phrases_block
            )
            tz_messages = [
                {"role": "system", "content": SYSTEM_PROMPT_TZ},
                {"role": "user", "content": tz_prompt},
            ]
            tz_text, tz_in_tokens, tz_out_tokens = chat_complete(
                client, tz_messages, max_tokens=MAX_TOKENS_TZ
            )

            # –°—Ç–∞—Ç—å—è
            article_id = f"ID{i:05d}"
            art_prompt = ARTICLE_USER_PROMPT_TEMPLATE.format(
                article_id=article_id, tz_text=tz_text
            )

            response = client.responses.create(
                model="gpt-4.1",
                input=art_prompt,
                tools=[{
                    "type": "file_search",
                    "vector_store_ids": [vector_store_id],
                    "max_num_results": 10
                }],
                temperature=TEMPERATURE,
                max_output_tokens=10000,
                instructions=INSTRUCTIONS_ARTICLE
            )
            html_text = response.output_text.strip()

            # —Å–Ω—è—Ç—å –≤–æ–∑–º–æ–∂–Ω—ã–µ ```html
            fence = re.compile(r"^```\\s*html\\s*|\\s*```$", re.I)
            html_text = "\n".join(
                line for line in html_text.splitlines() if not fence.match(line)
            ).strip()

            # –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ/–∑–∞–≥–æ–ª–æ–≤–æ–∫
            h1 = re.search(r"<h1[^>]*>(.*?)</h1>", html_text, flags=re.I | re.S)
            title = html.unescape(h1.group(1).strip()) if h1 else main_query.title()
            slug = slugify(title)

            # –ó–∞–ø–∏—Å—å –≤ –æ–±—â–∏–π CSV
            writer.writerow({"title": title, "slug": slug, "tz": tz_text, "html": html_text})
            tqdm.write(f"‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ CSV: {slug}")

            # (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π html –Ω–∞ —Ö–æ—Å—Ç–µ
            if save_html:
                out_dir = BASE_DIR / "output"
                out_dir.mkdir(exist_ok=True)
                out_file = out_dir / f"{slug}.html"
                out_file.write_text(html_text, encoding="utf-8")
                saved_html_files.append(str(out_file))
                tqdm.write(f"üíæ HTML-—Ñ–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—ë–Ω –Ω–∞ —Ö–æ—Å—Ç–µ: {out_file}")

            # –°—Ç–æ–∏–º–æ—Å—Ç—å
            art_in_tokens = count_tokens(art_prompt)
            art_out_tokens = count_tokens(html_text)

            tz_cost = calculate_cost(tz_in_tokens, True) + calculate_cost(tz_out_tokens, False)
            art_cost = calculate_cost(art_in_tokens, True) + calculate_cost(art_out_tokens, False)
            art_total_cost = tz_cost + art_cost
            total_cost += art_total_cost

            tqdm.write(
                f"üî∏ –¢–æ–∫–µ–Ω—ã –¢–ó (in/out): {tz_in_tokens}/{tz_out_tokens} | "
                f"–°—Ç–∞—Ç—å—è (in/out): {art_in_tokens}/{art_out_tokens} | "
                f"–°—Ç–æ–∏–º–æ—Å—Ç—å: ${art_total_cost:.4f} (—Å—É–º–º–∞: ${total_cost:.4f})"
            )
            pbar.set_postfix_str(f"—Å—É–º–º–∞ ${total_cost:.4f}")

        pbar.close()

    tqdm.write(f"–ì–æ—Ç–æ–≤–æ ‚Üí —Ñ–∞–π–ª {out_csv}")
    tqdm.write(f"–ò–¢–û–ì–û–í–ê–Ø —Å—É–º–º–∞: ${total_cost:.4f}")

    return {
        "articles_csv": str(out_csv),
        "total_cost": round(total_cost, 4),
        "groups_processed": len(groups_slice),
        "saved_html_files": saved_html_files,
    }

# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ FASTAPI ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
class GenerateRequest(BaseModel):
    input_csv: str
    groups_start: int = 0
    groups_end: Optional[int] = None  # null => –¥–æ –∫–æ–Ω—Ü–∞
    save_html: bool = False

app = FastAPI(title="Articles Generator API")

@app.post("/articles_generator")
def articles_generator(req: GenerateRequest):
    try:
        result = generate_articles(
            input_csv=Path(req.input_csv),
            groups_start=req.groups_start,
            groups_end=req.groups_end,
            save_html=req.save_html,
        )
        return {"ok": True, **result}
    except FileNotFoundError as e:
        raise HTTPException(status_code=400, detail=str(e))
    except Exception as e:
        # –õ–æ–≥ –∏ –ø—Ä–æ–±—Ä–æ—Å
        logging.exception("–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏")
        raise HTTPException(status_code=500, detail=str(e))


#if __name__ == "__main__":
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–µ—Ä –Ω–∞ 0.0.0.0:8001
    #uvicorn.run("app:app", host="0.0.0.0", port=8001, reload=False)


@app.post("/articles_generator_upload")
async def articles_generator_upload(
    background: BackgroundTasks,
    file: UploadFile = File(...),
    groups_start: int = Form(0),
    groups_end: int | None = Form(None),
    save_html: bool = Form(False),
    keep_server_copy: bool = Form(True),
):
    logging.info(f"UPLOAD start: {file.filename}, groups_start={groups_start}, groups_end={groups_end}, save_html={save_html}, keep={keep_server_copy}")
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Ö–æ–¥–Ω–æ–π CSV –∏–º–µ–Ω–Ω–æ –≤ BASE_DIR (volume)
    tmp_name = f"{uuid.uuid4()}_{file.filename}"
    tmp_path = BASE_DIR / tmp_name
    with tmp_path.open("wb") as f:
        f.write(await file.read())

    try:
        result = generate_articles(
            input_csv=tmp_path,
            groups_start=groups_start,
            groups_end=groups_end,
            save_html=save_html,
        )
        csv_path = Path(result["articles_csv"])

        headers = {
        "X-Groups-Processed": str(result.get("groups_processed", "")),
        "X-Total-Cost": str(result.get("total_cost", "")),
        "X-Articles-Filename": csv_path.name,  # –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ
         }

        # –ï—Å–ª–∏ –Ω–µ —Ö–æ—Ç–∏–º —Ö—Ä–∞–Ω–∏—Ç—å –∏—Ç–æ–≥–æ–≤—ã–π —Ñ–∞–π–ª –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ ‚Äî —É–¥–∞–ª—è–µ–º –ø–æ—Å–ª–µ –æ—Ç–¥–∞—á–∏
        if not keep_server_copy:
            background.add_task(os.remove, csv_path)

        # –í –ª—é–±–æ–º —Å–ª—É—á–∞–µ —É–¥–∞–ª—è–µ–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π CSV –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏
        background.add_task(os.remove, tmp_path)

        return FileResponse(
        csv_path,
        media_type="text/csv",
        filename="articles.csv",
        headers=headers,
        background=background,
        )
    except Exception:
        # –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –ø–æ–¥—á–∏—Å—Ç–∏–º –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–π CSV –∏ –ø—Ä–∏ –æ—à–∏–±–∫–µ
        try: os.remove(tmp_path)
        except: pass
        raise


@app.post("/articles_generator_stream")
def articles_generator_stream(req: GenerateRequest):
    q = Queue()
    DONE = object()
    orig = tqdm.write

    def capture(msg, *a, **kw):
        text = msg if isinstance(msg, str) else str(msg)
        q.put(text)                 # –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
        orig(text, *a, **kw)        # –∏ –¥—É–±–ª–∏—Ä—É–µ–º –≤ —Å–µ—Ä–≤–µ—Ä–Ω—ã–µ –ª–æ–≥–∏

    def worker():
        try:
            tqdm.write = capture
            result = generate_articles(
                input_csv=Path(req.input_csv),
                groups_start=req.groups_start,
                groups_end=req.groups_end,
                save_html=req.save_html,
            )
            q.put(json.dumps({"_result": result}, ensure_ascii=False))
        except Exception as e:
            q.put(json.dumps({"_error": str(e)}, ensure_ascii=False))
        finally:
            tqdm.write = orig
            q.put(DONE)

    Thread(target=worker, daemon=True).start()

    def gen():
        yield "event: start\ndata: processing started\n\n"
        while True:
            item = q.get()
            if item is DONE:
                break
            yield f"data: {item}\n\n"
        yield "event: end\ndata: done\n\n"

    return StreamingResponse(gen(), media_type="text/event-stream")